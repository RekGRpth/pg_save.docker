#!/bin/sh

exec 2>&1
realpath "$0"
cd "$PGDATA"
set -ex
HOSTNAME="$(hostname)"
PRIMARY="$(curl -Ls "$ETCD/kv/range" -X POST -d "{\"key\":\"$KEY\"}" | jq --unbuffered --raw-output ".kvs | .[]?.value | @base64d")"
if [ -z "$PRIMARY" ]; then
    KEY="$(echo "primary" | jq --unbuffered --raw-output --raw-input "@base64")"
#    LEASE="$(curl -Ls "$ETCD/lease/grant" -X POST -d "{\"TTL\":60}" | jq --unbuffered --raw-output ".ID")"
    VALUE="$(echo "$HOSTNAME" | jq --unbuffered --raw-output --raw-input "@base64")"
#    RC="$(curl -Ls "$ETCD/kv/put" -X POST -d "{\"key\": \"$KEY\", \"value\": \"$VALUE\", \"lease\": \"$LEASE\"}")"
    RC="$(curl -Ls "$ETCD/kv/put" -X POST -d "{\"key\": \"$KEY\", \"value\": \"$VALUE\"}")"
    KEY="$(echo "$HOSTNAME" | jq --unbuffered --raw-output --raw-input "@base64")"
    TIMESTAMPTZ="$(date "+%F %T %Z")"
    VALUE="$(echo "$TIMESTAMPTZ" | jq --unbuffered --raw-output --raw-input "@base64")"
    RC="$(curl -Ls "$ETCD/kv/put" -X POST -d "{\"key\": \"$KEY\", \"value\": \"$VALUE\"}")"
    test "$HOSTNAME" == "$(curl -Ls "$ETCD/kv/range" -X POST -d "{\"key\":\"$KEY\"}" | jq --unbuffered --raw-output ".kvs | .[]?.value | @base64d")"
    initdb
    /etc/service/postgres/conf
    /etc/service/postgres/hba
else
    pg_isready --host="$PRIMARY"
    SLOT="$(echo "$HOSTNAME" | tr '.' '_')"
    pg_basebackup \
        --create-slot \
        --pgdata=. \
        --host="$PRIMARY" \
        --progress \
        --slot="$SLOT" \
        --verbose \
        --wal-method=stream \
        --write-recovery-conf
fi
