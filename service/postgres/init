#!/bin/sh

exec 2>&1
realpath "$0"
cd "$PGDATA"
set -ex
HOSTNAME="$(hostname)"
MAIN="$(etcdctl get main --print-value-only)"
if [ -z "$MAIN" ]; then
    RC="$(etcdctl put main "$HOSTNAME")"
    test "$RC" == "OK"
    initdb
    /etc/service/postgres/conf
    /etc/service/postgres/hba
else
    pg_isready --host="$MAIN"
    pg_basebackup \
        --create-slot \
        --pgdata=. \
        --host="$MAIN" \
        --progress \
        --slot="$HOSTNAME" \
        --verbose \
        --wal-method=stream \
        --write-recovery-conf
fi
