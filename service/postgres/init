#!/bin/sh

exec 2>&1
ln -fs ../pg_arclog "$PGDATA/pg_arclog"
ln -fs ../pg_log "$PGDATA/pg_log"
realpath "$0"
set -ex
PRIMARY="$(etcdctl get primary --endpoints="$ETCD" --print-value-only)"
if [ -n "$PRIMARY" ]; then
    /etc/service/postgres/basebackup
else
    HOSTNAME="$(hostname)"
    test "OK" == "$(etcdctl put primary "$HOSTNAME" --endpoints="$ETCD")"
    TIMESTAMPTZ="$(date "+%F %T%Z")"
    test "OK" == "$(etcdctl put "$HOSTNAME" "$TIMESTAMPTZ" --endpoints="$ETCD")"
    initdb "$PGDATA"
    /etc/service/postgres/conf
    /etc/service/postgres/hba
fi
