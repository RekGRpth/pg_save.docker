#!/bin/sh

exec 2>&1
realpath "$0"
cd "$PGDATA"
set -ex
HOSTNAME="$(hostname)"
KEY="$(echo "main" | base64)"
MAIN="$(curl -Ls "$ETCD/kv/range" -X POST -d "{\"key\":\"$KEY\"}" | jq --unbuffered --raw-output ".kvs | .[]?.value" | base64 -d)"
if [ -z "$MAIN" ]; then
    LEASE="$(curl -Ls "$ETCD/lease/grant" -X POST -d "{\"TTL\":60}" | jq --unbuffered --raw-output ".ID")"
    VALUE="$(echo "$HOSTNAME" | base64)"
    RC="$(curl -Ls "$ETCD/kv/put" -X POST -d "{\"key\": \"$KEY\", \"value\": \"$VALUE\", \"lease\": \"$LEASE\"}")"
    test "$HOSTNAME" == "$(curl -Ls "$ETCD/kv/range" -X POST -d "{\"key\":\"$KEY\"}" | jq --unbuffered --raw-output ".kvs | .[]?.value" | base64 -d)"
    initdb
    /etc/service/postgres/conf
    /etc/service/postgres/hba
else
    pg_isready --host="$MAIN"
    SLOT="$(echo "$HOSTNAME" | tr '.' '_')"
    pg_basebackup \
        --create-slot \
        --pgdata=. \
        --host="$MAIN" \
        --progress \
        --slot="$SLOT" \
        --verbose \
        --wal-method=stream \
        --write-recovery-conf
fi
