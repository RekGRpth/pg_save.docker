#!/bin/sh

exec 2>&1
realpath "$0"
set -ex
if [ ! -f "$PGDATA/standby.signal" ]; then
    PRIMARY="$(etcdctl get primary --endpoints="$ETCD" --print-value-only)"
    test -n "$PRIMARY"
    OLD_PRIMARY="$(sed -n "s|^pg_save\.primary = ||p" "$PGDATA/postgresql.auto.conf" | tr -d "'")"
    test -n "$OLD_PRIMARY"
    if [ "$OLD_PRIMARY" != "$PRIMARY" ]; then
        /etc/service/postgres/rewind || /etc/service/postgres/basebackup
    else
        TIMESTAMPTZ="$(date "+%F %T%Z")"
        SYNC="$(etcdctl get sync --endpoints="$ETCD" --print-value-only)"
        test -n "$SYNC"
        SYNC_TIMESTAMPTZ="$(etcdctl get "$SYNC" --endpoints="$ETCD" --print-value-only)"
        test -n "$SYNC_TIMESTAMPTZ"
        SYNC_SECOND="$(ddiff "$SYNC_TIMESTAMPTZ" "$TIMESTAMPTZ" -f "%S")"
        if [ "$SYNC_SECOND" -gt "30" ]; then
            exit 1
        fi
        POTENTIAL="$(etcdctl get potential --endpoints="$ETCD" --print-value-only)"
        test -n "$POTENTIAL"
        POTENTIAL_TIMESTAMPTZ="$(etcdctl get "$POTENTIAL" --endpoints="$ETCD" --print-value-only)"
        test -n "$POTENTIAL_TIMESTAMPTZ"
        POTENTIAL_SECOND="$(ddiff "$POTENTIAL_TIMESTAMPTZ" "$TIMESTAMPTZ" -f "%S")"
        if [ "$POTENTIAL_SECOND" -gt "30" ]; then
            exit 1
        fi
    fi
fi
