#!/bin/sh

exec 2>&1
realpath "$0"
set -ex
cd ..
BACKUP="$(mktemp -dup .)"
install -d -m 0750 -o "$USER" -g "$GROUP" "$BACKUP"
PRIMARY="$(psql --quiet --tuples-only --no-align --dbname="host=$SERVICE_NAME application_name=$(hostname) target_session_attrs=read-write" --command="SELECT current_setting('pg_save.hostname', false)")"
test -n "$PRIMARY"
if pg_basebackup \
    --dbname="host=$PRIMARY application_name=$(hostname) target_session_attrs=read-write" \
    --pgdata="$BACKUP" \
    --progress \
    --verbose \
    --wal-method=stream; then
    rm -rf "$PGDATA"
    mv "$BACKUP" "$PGDATA"
    cd "$PGDATA"
    touch standby.signal
    cat >>postgresql.auto.conf <<EOF
primary_conninfo = 'host=$PRIMARY application_name=$(hostname) target_session_attrs=read-write'
EOF
else
    rm -rf "$BACKUP"
    cd "$PGDATA"
fi
